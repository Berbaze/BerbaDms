@page
@model DmsProjeckt.Pages.Dokument.IndexierteModel
@{
    ViewData["Title"] = "📂 Indexierte Dokumente";
}

@section Styles {
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
    <style>
        body {
            background: #181a1e;
        }

        .modern-table-wrapper {
            background: #181a1e;
            border-radius: 16px;
            box-shadow: 0 6px 30px #0007, 0 1px 4px #ffce481a;
            border: 2px solid #ffce4840;
            padding: 1.2rem 1.3rem 1.3rem 1.3rem;
            margin: 30px auto 0 auto;
            /* overflow-x: auto;  <-- entfernt wegen Dropdown-Problemen */
        }

        .modern-table {
            background: transparent !important;
            border-radius: 12px;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 1em;
            color: #fffbe7;
            width: 100%;
        }

            .modern-table th {
                background: linear-gradient(90deg, #ffe17a 60%, #23272e 100%);
                color: #23262b;
                font-weight: 800;
                font-size: 1.08em;
                padding: 0.7em 0.7em;
                border-bottom: 2.2px solid #ffce48;
            }

            .modern-table td {
                color: #fffbe7;
                padding: 0.62em 0.68em;
                background: #181a1e;
                border-bottom: 1px solid #23262b;
                font-size: 1em;
                vertical-align: middle;
            }

            .modern-table tbody tr:hover {
                background: linear-gradient(90deg, #ffe8aa33 8%, #23262b 85%);
                color: #ffd700;
            }

        .badge {
            border-radius: 7px;
            font-weight: 600;
            padding: 0.18em 1.02em !important;
            font-size: 0.97em !important;
            background: #22252b !important;
            color: #ffc107 !important;
        }

        .btn-action {
            background: #24101a !important;
            color: #ffbf47 !important;
            border: none !important;
            border-radius: 7px !important;
            transition: background 0.13s, color 0.13s;
            font-size: 1.07em;
        }

            .btn-action:focus, .btn-action:hover {
                background: #ffe17a33 !important;
                color: #222 !important;
            }

        .dropdown-menu-dark {
            background: #22252b !important;
        }

        .dropdown-item {
            color: #ffc107 !important;
        }

            .dropdown-item.text-danger {
                color: #ff4266 !important;
            }

        /* FIX für Dropdown: Immer über Wrapper anzeigen */
        .dropdown-menu {
            position: absolute !important;
            z-index: 1055 !important;
        }
    </style>
}

<h2 class="fw-bold text-light mb-4"><i class="bi bi-search text-warning"></i> Indexierte Dokumente</h2>

<div class="modern-table-wrapper">
    <table class="modern-table">
        <thead>
            <tr>
                <th>Titel</th>
                <th>Kategorie</th>
                <th>Rechnungsnummer</th>
                <th>Rechnungsdatum</th>
                <th>Betrag</th>
                <th>Fälligkeitsdatum</th>
                <th>Aktionen</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var doc in Model.IndexDocs)
            {
                <tr>
                    <td>@doc.Titel</td>
                    <td>@doc.Kategorie</td>
                    <td>@doc.Rechnungsnummer</td>
                    <td>@doc.Rechnungsdatum?.ToString("dd.MM.yyyy")</td>
                    <td>@($"{doc.Rechnungsbetrag ?? 0:n2} €")</td>
                    <td>@doc.Faelligkeitsdatum?.ToString("dd.MM.yyyy")</td>
                    <td style="text-align:center;">
                        <div class="dropdown">
                            <button class="btn btn-sm btn-action dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="bi bi-three-dots-vertical"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-dark">
                                <!-- Vorschau -->
                                <li>
                                    <a class="dropdown-item" href="/Dokument/Preview?id=@doc.DokumentId" target="_blank">
                                        <i class="bi bi-eye me-1"></i> Vorschau
                                    </a>
                                </li>
                                <!-- Herunterladen -->
                                <li>
                                    <a class="dropdown-item" href="/Dokument/Download?id=@doc.DokumentId">
                                        <i class="bi bi-download me-1"></i> Herunterladen
                                    </a>
                                </li>
                                <!-- Umbenennen -->
                                <li>
                                    <a class="dropdown-item" href="javascript:void(0);" onclick="openRenameModal('@doc.DokumentId', '@doc.Titel')">
                                        <i class="bi bi-pencil-square me-1"></i> Umbenennen
                                    </a>
                                </li>
                                <!-- Teilen per E-Mail -->
                                <li>
                                    <a class="dropdown-item" href="javascript:void(0);" onclick="openShareModal('@doc.DokumentId', '@doc.Titel')">
                                        <i class="bi bi-envelope me-1"></i> Teilen per E-Mail
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <!-- Löschen -->
                                <li>
                                    <a class="dropdown-item text-danger" href="javascript:void(0);" onclick="openDeleteModal('@doc.DokumentId', '@doc.Titel')">
                                        <i class="bi bi-trash me-1"></i> Löschen
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- Rename Modal -->
<div class="modal fade" id="renameModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title">Dokument umbenennen</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="renameForm">
                    <input type="hidden" id="renameDokumentId" />
                    <div class="mb-3">
                        <label>Neuer Name</label>
                        <input type="text" class="form-control" id="renameNewTitle" required />
                    </div>
                    <button type="submit" class="btn btn-warning">Speichern</button>
                </form>
                <div id="renameStatus" class="mt-2"></div>
            </div>
        </div>
    </div>
</div>

<!-- Share Modal -->
<div class="modal fade" id="shareModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title">Dokument teilen</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="shareForm">
                    <input type="hidden" id="shareDokumentId" />
                    <div class="mb-3">
                        <label>E-Mail Empfänger</label>
                        <input type="email" class="form-control" id="shareEmail" required />
                    </div>
                    <button type="submit" class="btn btn-success">Senden</button>
                </form>
                <div id="shareStatus" class="mt-2"></div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title">Löschen bestätigen</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="deleteConfirmText"></p>
                <form id="deleteForm">
                    <input type="hidden" id="deleteDokumentId" />
                    <button type="submit" class="btn btn-danger">Ja, löschen</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                </form>
                <div id="deleteStatus" class="mt-2"></div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Rename Modal
        function openRenameModal(dokId, oldTitle) {
            document.getElementById('renameDokumentId').value = dokId;
            document.getElementById('renameNewTitle').value = oldTitle;
            document.getElementById('renameStatus').innerHTML = '';
            new bootstrap.Modal(document.getElementById('renameModal')).show();
        }
        document.getElementById('renameForm').onsubmit = async function(e) {
            e.preventDefault();
            let dokId = document.getElementById('renameDokumentId').value;
            let newTitle = document.getElementById('renameNewTitle').value;

            let resp = await fetch('/api/dokument/rename', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ dokumentId: dokId, neuerName: newTitle })
            });
            if (resp.ok) {
                document.getElementById('renameStatus').innerText = "Erfolgreich umbenannt!";
                setTimeout(()=>location.reload(), 1000);
            } else {
                document.getElementById('renameStatus').innerText = "Fehler beim Umbenennen.";
            }
        };


        // Share Modal
        function openShareModal(dokId, titel) {
            document.getElementById('shareDokumentId').value = dokId;
            document.getElementById('shareEmail').value = '';
            document.getElementById('shareStatus').innerHTML = '';
            new bootstrap.Modal(document.getElementById('shareModal')).show();
        }
        document.getElementById('shareForm').onsubmit = function(e) {
            e.preventDefault();
            // TODO: AJAX-Call an Share-API
            document.getElementById('shareStatus').innerText = "E-Mail gesendet (Demo)";
        };

        // Delete Modal
        function openDeleteModal(dokId, title) {
            document.getElementById('deleteDokumentId').value = dokId;
            document.getElementById('deleteStatus').innerHTML = '';
            document.getElementById('deleteConfirmText').innerHTML = `Möchten Sie das Dokument <strong>${title}</strong> wirklich löschen?`;
            new bootstrap.Modal(document.getElementById('deleteModal')).show();
        }
        document.getElementById('deleteForm').onsubmit = function(e) {
            e.preventDefault();
            // TODO: AJAX-Call an Delete-API
            document.getElementById('deleteStatus').innerText = "Gelöscht (Demo)";
        };
    </script>
}
